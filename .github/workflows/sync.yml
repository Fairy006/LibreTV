  name: Upstream Sync

permissions:
  contents: write
  issues: write

on:
  schedule:
    - cron: "0 4 * * *"  # 每天UTC时间4点（北京时间12点）
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}

    steps:
      # 1. 检出你的 fork
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 添加上游仓库
      - name: Add upstream
        run: git remote add upstream https://github.com/LibreSpark/LibreTV.git

      # 3. 拉取上游最新代码
      - name: Fetch upstream
        run: git fetch upstream

      # 4. 合并上游到 main (冲突保留上游版本)
      - name: Merge upstream/main into main
        run: |
          git checkout main
          git merge -X theirs upstream/main --allow-unrelated-histories

      # 5. 安全检查：禁止推送到上游仓库
      - name: Safety check
        run: |
          REMOTE_URL=$(git remote get-url origin)
          if [[ $REMOTE_URL == *"LibreSpark/LibreTV"* ]]; then
            echo "::error::Origin 指向上游仓库，禁止推送！"
            exit 1
          fi

      # 6. 推送到 fork
      - name: Push changes
        id: push_result
        run: |
          if git push origin main; then
            echo "push_status=success" >> $GITHUB_OUTPUT
          else
            echo "push_status=fail" >> $GITHUB_OUTPUT
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 7. 关闭旧的同步 Issue
      - name: Close old sync issues
        run: |
          gh issue list --search "title:同步成功 OR title:同步失败" --state open --json number \
            | jq -r '.[].number' \
            | while read -r issue_num; do
                gh issue close $issue_num --comment "自动同步任务运行前关闭旧记录。"
              done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. 创建同步结果 Issue
      - name: Create sync status issue
        if: always()
        run: |
          STATUS="${{ steps.push_result.outputs.push_status || 'error' }}"
          DATE=$(date '+%Y-%m-%d %H:%M:%S')
          
          if [ "$STATUS" = "success" ]; then
            TITLE="📍 同步成功 [$DATE]"
            BODY="✅ 你的 fork 已成功同步上游仓库 **LibreSpark/LibreTV** 的最新 main 分支。"
          elif [ "$STATUS" = "fail" ]; then
            TITLE="✗ 同步失败 [$DATE]"
            BODY="❌ 推送失败！请检查 Actions 日志并手动处理。\n> 可能原因：权限不足、网络问题或分支保护"
          else
            TITLE="⚠️ 同步错误 [$DATE]"
            BODY="❗ 安全检查失败或合并冲突！请确认：\n1. origin 未指向上游仓库\n2. 本地 main 分支无冲突"
          fi
          
          gh issue create --title "$TITLE" --body "$BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
